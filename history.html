<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bill History - SPORTS WORLD Shop</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
    }

    h1 {
      font-family: 'Montserrat', sans-serif;
      text-align: center;
      color: #00b7ff;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 20px;
      font-size: 1.8rem;
    }

    h2 {
      font-family: 'Roboto', sans-serif;
      color: #80d4ff;
      margin-bottom: 15px;
      font-size: 1.4rem;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #2a2a2a;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    input, button {
      font-family: 'Open Sans', sans-serif;
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #404040;
      border-radius: 5px;
      width: 100%;
      transition: all 0.3s ease;
      background: #333;
      color: #e0e0e0;
    }

    input:focus {
      border-color: #00b7ff;
      outline: none;
      box-shadow: 0 0 5px rgba(0, 183, 255, 0.3);
    }

    button {
      background: #00b7ff;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 600;
      text-transform: uppercase;
    }

    button:hover {
      background: #008ecf;
    }

    .delete-btn {
      background: #ff4d4d;
      padding: 5px 10px;
      font-size: 12px;
      width: auto;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .delete-btn:hover {
      background: #e60000;
    }

    .nav-link {
      text-align: center;
      margin-top: 20px;
    }

    .nav-link a {
      color: #80d4ff;
      text-decoration: none;
      font-weight: 600;
      font-family: 'Roboto', sans-serif;
      margin: 0 15px;
      transition: color 0.3s ease;
    }

    .nav-link a:hover {
      color: #00b7ff;
    }

    .day-card {
      background: #252525;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 5px solid #00b7ff;
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .bill-item {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      background: #333;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 5px;
    }

    .bill-item:hover {
      background: #404040;
    }

    #bill-details-view {
      margin-top: 20px;
      padding: 15px;
      background: #222;
      border-radius: 8px;
      display: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #444;
    }

    .total-row {
      text-align: right;
      margin-top: 10px;
    }

    @media (max-width: 480px) {
      .nav-link a { display: block; margin: 10px 0; }
    }
  </style>
</head>
<body>
  <h1>Bill History - SPORTS WORLD Shop</h1>
  <div class="container">
    <div id="auth-section">
      <h2>Access Records</h2>
      <input id="password" type="password" placeholder="Enter Password">
      <button onclick="checkPassword()">View History</button>
    </div>

    <div id="history-section" style="display: none;">
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input type="date" id="date-filter" onchange="filterByDate()">
        <button onclick="resetFilter()" style="width: auto; padding: 0 15px;">Reset</button>
      </div>
      <div id="daily-summary"></div>
      <div id="bill-details-view"></div>
    </div>
  </div>

  <div class="nav-link">
    <a href="/index.html">Back to Billing</a> |
    <a href="/add-item.html">Add/Edit Items</a> |
    <a href="/view-bill.html">View Bill</a>
  </div>

  <script>
    const correctPassword = "gourab009";

    function checkPassword() {
      const input = document.getElementById('password').value;
      if (input === correctPassword) {
        document.getElementById('auth-section').style.display = 'none';
        document.getElementById('history-section').style.display = 'block';
        fetchBills();
      } else {
        alert("Incorrect password!");
      }
    }

    async function fetchBills() {
      const res = await fetch('/bills');
      const bills = await res.json();
      displayHistory(bills);
    }

    function displayHistory(bills) {
      const container = document.getElementById('daily-summary');
      container.innerHTML = '';

      const grouped = bills.reduce((acc, bill) => {
        const date = new Date(bill.date).toLocaleDateString('en-GB');
        if (!acc[date]) acc[date] = { bills: [], total: 0 };
        
        const subtotal = bill.items.reduce((s, i) => s + (i.price * (i.qty - (i.returnedQty || 0))), 0);
        acc[date].bills.push(bill);
        acc[date].total += (subtotal - (bill.discount || 0));
        return acc;
      }, {});

      Object.entries(grouped).forEach(([date, data]) => {
        const card = document.createElement('div');
        card.className = 'day-card';
        card.innerHTML = `
          <div class="day-header">
            <h3>${date}</h3>
            <span style="color:#00ffcc; font-weight:bold;">Total: ₹${data.total}</span>
          </div>
          ${data.bills.map(b => {
            const bSub = b.items.reduce((s, i) => s + (i.price * (i.qty - (i.returnedQty || 0))), 0);
            return `
              <div class="bill-item" onclick="showDetails(${JSON.stringify(b).replace(/"/g, '&quot;')})">
                <span>Serial: ${b.serialNumber}</span>
                <span>₹${bSub - (b.discount || 0)}</span>
              </div>`;
          }).join('')}
        `;
        container.appendChild(card);
      });
    }

    function showDetails(bill) {
      const view = document.getElementById('bill-details-view');
      const subtotal = bill.items.reduce((s, i) => s + (i.price * (i.qty - (i.returnedQty || 0))), 0);
      view.style.display = 'block';
      view.innerHTML = `
        <div style="display:flex; justify-content:space-between;">
          <h3>Details: #${bill.serialNumber}</h3>
          <button onclick="document.getElementById('bill-details-view').style.display='none'" style="width:auto; padding:0 10px;">X</button>
        </div>
        <table>
          <thead><tr><th>Item</th><th>Qty</th><th>Total</th></tr></thead>
          <tbody>
            ${bill.items.map(i => `<tr><td>${i.name}</td><td>${i.qty - (i.returnedQty || 0)}</td><td>₹${i.price * (i.qty - (i.returnedQty || 0))}</td></tr>`).join('')}
          </tbody>
        </table>
        <div class="total-row">
          <p>Subtotal: ₹${subtotal}</p>
          ${bill.discount > 0 ? `<p style="color:#ff4d4d;">Discount: -₹${bill.discount}</p>` : ''}
          <p><strong style="color:#00b7ff; font-size:1.2rem;">Grand Total: ₹${subtotal - (bill.discount || 0)}</strong></p>
        </div>
      `;
      view.scrollIntoView({ behavior: 'smooth' });
    }

    function filterByDate() {
      const val = document.getElementById('date-filter').value;
      if (!val) return fetchBills();
      const selected = new Date(val).toLocaleDateString('en-GB');
      const cards = document.querySelectorAll('.day-card');
      cards.forEach(c => {
        const d = c.querySelector('h3').textContent;
        c.style.display = d === selected ? 'block' : 'none';
      });
    }

    function resetFilter() {
      document.getElementById('date-filter').value = '';
      fetchBills();
    }
  </script>
</body>
</html>
