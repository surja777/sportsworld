<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPORTS WORLD Shop</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: #1a1a1a; color: #e0e0e0; padding: 20px; line-height: 1.6; }
    h1 { font-family: 'Montserrat', sans-serif; text-align: center; color: #00b7ff; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 20px; font-size: 1.8rem; }
    h2 { font-family: 'Roboto', sans-serif; color: #80d4ff; margin-bottom: 15px; font-size: 1.4rem; }
    .container { max-width: 1200px; margin: 0 auto; display: flex; flex-wrap: wrap; gap: 20px; background: #2a2a2a; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
    .inventory, .billing { flex: 1; min-width: 300px; padding: 15px; background: #252525; border-radius: 8px; border: 1px solid #404040; }
    .inventory-table-wrapper { max-height: 400px; overflow-y: auto; border: 1px solid #404040; border-radius: 5px; }
    input, button { font-family: 'Open Sans', sans-serif; padding: 10px; margin: 5px 0; border: 1px solid #404040; border-radius: 5px; width: 100%; transition: all 0.3s ease; background: #333; color: #e0e0e0; }
    input:focus { border-color: #00b7ff; outline: none; box-shadow: 0 0 5px rgba(0, 183, 255, 0.3); }
    button { background: #00b7ff; color: #fff; border: none; cursor: pointer; font-weight: 600; text-transform: uppercase; }
    button:hover { background: #008ecf; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #2a2a2a; border-radius: 5px; overflow: hidden; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #404040; }
    th { background: #004d73; color: #fff; position: sticky; top: 0; z-index: 1; }
    .nav-link { text-align: center; margin-top: 20px; }
    .nav-link a { color: #80d4ff; text-decoration: none; font-weight: 600; margin: 0 15px; }
    #results { margin-top: 5px; background: #2a2a2a; border-radius: 5px; }
    #results p { padding: 12px; border-bottom: 1px solid #404040; cursor: pointer; }
    #results p:hover { background: #3d3d3d; }
    .total-area { margin-top: 15px; padding: 10px; background: #1a1a1a; border-radius: 5px; }
    .discount-input { border: 1px solid #ff4d4d !important; }
  </style>
</head>
<body>
  <h1>SPORTS WORLD Shop</h1>
  <div class="container">
    <div class="inventory">
      <h2>Inventory</h2>
      <div class="inventory-table-wrapper">
        <table id="items">
          <thead><tr><th>Name</th><th>Price</th><th>Stock</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="billing">
      <h2>Billing</h2>
      <input id="customer" placeholder="Customer Name (Optional)">
      <input id="phone" placeholder="Customer Phone Number (Optional)">
      <input id="search" placeholder="Search Items">
      <div id="results"></div>
      <input id="qty" type="number" placeholder="Quantity">
      <button onclick="addToBill()">Add to Bill</button>
      <div id="bill"></div>
      <div class="total-area">
        <input id="discount" class="discount-input" type="number" placeholder="Enter Discount Amount" oninput="updateBill()">
        <div id="price-summary"></div>
      </div>
      <button onclick="printBill()">Print</button>
    </div>
  </div>
  <div class="nav-link">
    <a href="/add-item.html">Add/Edit Items</a> |
    <a href="/view-bill.html">View Bill by Serial</a> |
    <a href="/history.html">Bill History</a>
  </div>
  <script>
    let bill = [];
    let printer = null;
    let selectedItem = null;

    async function fetchInventory() {
      const res = await fetch('/items');
      const items = await res.json();
      const tbody = document.querySelector('#items tbody');
      tbody.innerHTML = '';
      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${item.name}</td><td>${item.price}</td><td>${item.stock}</td>`;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('search').oninput = async () => {
      const query = document.getElementById('search').value.toLowerCase();
      if (!query) { document.getElementById('results').innerHTML = ''; return; }
      const res = await fetch('/items');
      const items = await res.json();
      const results = items.filter(item => item.name.toLowerCase().includes(query));
      const div = document.getElementById('results');
      div.innerHTML = '';
      results.forEach(item => {
        const p = document.createElement('p');
        p.textContent = `${item.name} (Price: ${item.price}, Stock: ${item.stock})`;
        p.onclick = () => {
          document.getElementById('search').value = item.name;
          div.innerHTML = '';
          selectedItem = item;
        };
        div.appendChild(p);
      });
    };

    function addToBill() {
      const qty = Number(document.getElementById('qty').value);
      if (!selectedItem || qty <= 0 || qty > selectedItem.stock) { alert('Invalid qty!'); return; }
      bill.push({ ...selectedItem, qty });
      document.getElementById('search').value = '';
      document.getElementById('qty').value = '';
      selectedItem = null;
      updateBill();
    }

    function updateBill() {
      const div = document.getElementById('bill');
      const summaryDiv = document.getElementById('price-summary');
      div.innerHTML = '';
      if (bill.length === 0) { summaryDiv.innerHTML = ''; return; }
      
      const table = document.createElement('table');
      table.innerHTML = `<thead><tr><th>Name</th><th>Qty</th><th>Total</th><th>Action</th></tr></thead>
        <tbody>${bill.map((item, i) => `<tr><td>${item.name}</td><td>${item.qty}</td><td>${item.price * item.qty}</td>
        <td><button onclick="removeItem(${i})">X</button></td></tr>`).join('')}</tbody>`;
      div.appendChild(table);

      const subtotal = bill.reduce((sum, item) => sum + item.price * item.qty, 0);
      const discount = Number(document.getElementById('discount').value) || 0;
      summaryDiv.innerHTML = `
        <p>Subtotal: ₹${subtotal}</p>
        ${discount > 0 ? `<p style="color: #ff4d4d;">Discount: -₹${discount}</p>` : ''}
        <p><strong>Grand Total: ₹${subtotal - discount}</strong></p>
      `;
    }

    function removeItem(index) { bill.splice(index, 1); updateBill(); }

    async function connectToPrinter() {
      if (!navigator.bluetooth) return alert('Use Chrome!');
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }],
          optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        const char = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
        return { device, char };
      } catch (e) { alert('Printer error'); return null; }
    }

    function encodeBill(bill, customer, phone, serialNumber, discount = 0) {
      let text = "============================\n";
      text += "          SPORTS WORLD          \n";
      text += "============================\n\n";
      text += `Customer: ${customer || 'N/A'}\n`;
      if (phone) text += `Phone: ${phone}\n`;
      text += `Date: ${new Date().toLocaleString()}\n`;
      text += `Serial No: ${serialNumber}\n`;
      text += "----------------------------\n";
      text += "Qnty Particulars    Rate Amount\n";
      text += "----------------------------\n";

      bill.forEach(item => {
        text += `${item.qty.toString().padStart(4)} ${item.name.slice(0,12).padEnd(12)} ${item.price.toString().padStart(6)} ${(item.price * item.qty).toString().padStart(6)}\n`;
      });

      const subtotal = bill.reduce((sum, item) => sum + item.price * item.qty, 0);
      text += "----------------------------\n";
      text += `Subtotal:           ${subtotal.toString().padStart(8)}\n`;
      if (discount > 0) text += `Discount:          -${discount.toString().padStart(8)}\n`;
      text += `TOTAL:              ${(subtotal - discount).toString().padStart(8)}\n`;
      text += "----------------------------\n";
      text += "Address: Swarupganj, Nadia\n";
      text += "Thank You! Visit Again!\n";
      text += "============================\n\n\n";
      return text;
    }

    async function printBill() {
      const btn = document.querySelector('button[onclick="printBill()"]');
      btn.disabled = true;
      try {
        if (!printer) printer = await connectToPrinter();
        const serial = Math.floor(1000000000 + Math.random() * 9000000000).toString();
        const discount = Number(document.getElementById('discount').value) || 0;
        
        // Print Logic
        const billText = encodeBill(bill, document.getElementById('customer').value, document.getElementById('phone').value, serial, discount);
        const encoder = new TextEncoder();
        const data = encoder.encode(billText);
        for (let i = 0; i < data.length; i += 128) {
          await printer.char.writeValue(data.slice(i, i + 128));
          await new Promise(r => setTimeout(r, 100));
        }

        // Save Logic
        await fetch('/bill', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            items: bill, 
            customer: document.getElementById('customer').value, 
            phone: document.getElementById('phone').value, 
            date: new Date().toISOString(), 
            serialNumber: serial,
            discount
          })
        });

        // Stock Logic
        for (const item of bill) {
          await fetch(`/items/${item._id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stock: item.stock - item.qty })
          });
        }

        alert('Done!');
        bill = []; updateBill(); fetchInventory();
        document.getElementById('discount').value = '';
      } catch (e) { alert(e.message); }
      btn.disabled = false;
    }

    fetchInventory();
  </script>
</body>
</html>
